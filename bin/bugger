#! /usr/bin/env bash
. ~/.bugger/bug.conf

find_latest_task(){
    id=$(sqlite3 $bugger_db "select id from bugger where timestop is null ;")
    if [[ ! -z "$id" ]]; then
        old_task=$(sqlite3 $bugger_db "select task from bugger where id = $id ;")
        seconds_spent=$(sqlite3 $bugger_db "SELECT (strftime('%s','now') - strftime('%s',timeStart))  from bugger where id = $id ;")
        old_time=$(printf "%02uh:%02um" $(($seconds_spent/10000)) $(($seconds_spent/100%100)))

    fi
}

register_current_task(){
    new_task=$($bugger_cocoa standard-inputbox --title "Bugger - What are you working on?" --text "$old_task" --float --no-newline --no-cancel --informative-text "Time spent on current task: $old_time" | tail -n 1)
    if [[ ! -z "$new_task" && "$new_task" != "$old_task" ]]; then
        if [[ ! -z "$id" ]]; then
            sqlite3 $bugger_db "update bugger set timeStop = DATETIME('now') where id=$id;"
        fi
        sqlite3 $bugger_db "insert into bugger values(null, \"$new_task\", DATETIME('now'), null);"
    fi
}

find_latest_task
register_current_task
